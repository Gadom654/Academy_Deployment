name: Payment App Infra - Terraform

on:
  push:
    paths:
      - 'AWS/paymentApp/infra/**' 

permissions:
  id-token: write
  contents: read
  security-events: write

jobs:
  plan:
    uses: Gadom654/Academy_Deployment/.github/workflows/AWS-terraform-plan.yml@main
    with:
      working_directory: "./AWS/paymentApp/infra"
    secrets:
      aws_role: ${{ secrets.AWS_PLAN_ROLE }}
  apply:
    needs: plan  
    uses: Gadom654/Academy_Deployment/.github/workflows/AWS-terraform-apply.yml@main
    with:
      working_directory: "./AWS/paymentApp/infra"
    secrets:
      aws_role: ${{ secrets.AWS_APPLY_ROLE }} 
  destroy:  
    uses: Gadom654/Academy_Deployment/.github/workflows/AWS-terraform-destroy.yml@main
    with:
      working_directory: "./AWS/paymentApp/infra"
    secrets:
      aws_role: ${{ secrets.AWS_APPLY_ROLE }}
  deployalbcontroller:
    uses: Gadom654/Academy_Deployment/.github/workflows/AWS-install-albcontroller.yml@main
    with:
      environment: "DOCKER"
      working_directory: "./AWS/paymentApp/infra"
      cluster_name: "paymentapp-prod-platform-cluster"
    secrets:
      aws_role: ${{ secrets.AWS_APPLY_ROLE }}
      VPN_CONFIG: ${{ secrets.VPN_CONFIG }}